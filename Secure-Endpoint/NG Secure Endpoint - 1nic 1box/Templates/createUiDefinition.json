{
  "handler": "Microsoft.Compute.MultiVm",
  "version": "0.0.1-preview",
  "parameters": {
    "basics": [
      {
        "name": "fwVmName",
        "type": "Microsoft.Common.TextBox",
        "label": "Firewall Instance Host Name",
        "toolTip": "Provide host name for newly created instance of Barracuda NextGen Firewall F",
        "defaultValue": "BarracudaNGFW",
        "constraints": {
          "required": true,
          "regex": "^[A-Za-z0-9-_]{1,15}$",
          "validationMessage": "Only alphanumeric characters are allowed, and the value must be 1 to 15 characters."
        }
      },
      {
        "name": "fwVmRootPasswd",
        "type": "Microsoft.Common.PasswordBox",
        "label": "Password for 'root' user",
        "toolTip": "Provide password for main administrative account. Username is always set to 'root'.",
        "constraints": {
          "required": true,
          "regex": "^(?:(?=.*[a-z])(?:(?=.*[A-Z])(?=.*[\\d\\W])|(?=.*\\W)(?=.*\\d))|(?=.*\\W)(?=.*[A-Z])(?=.*\\d)).{6,72}$",
          "validationMessage": "Your root password should be at least 6 characters long"
        },
        "options": {
          "hideConfirmation": true
        }
      }

    ],
    "steps": [
      {
        "name": "NetworkConfig",
        "label": "Network Settings",
        "subLabel": {
          "preValidation": "Configure networking settings",
          "postValidation": "Done"
        },
        "bladeTitle": "Network Settings",
        "elements": [
          {
            "name": "publicIp",
            "type": "Microsoft.Network.PublicIpAddressCombo",
            "label": {
              "publicIpAddress": "Public IP Address Name",
              "domainNameLabel": "Domain Name Label"
            },
            "toolTip": {
              "publicIpAddress": "Name of public IP address ARM resource",
              "domainNameLabel": "Prefix to use for public IP address DNS name (eg. [prefix].[region].cloudapp.azure.com)"
            },
            "defaultValue": {
              "publicIpAddress": "[concat( basics( 'fwVmName' ), '-pip' )]",
              "domainNameLabel": "[basics( 'fwVmName' )]"
            },
            "options": {
              "hideNone": false,
              "hideDomainNameLabel": false
            },
            "constraints": {
              "required": false
            },
            "visible": true
          },
          {
            "name": "virtualNetwork",
            "type": "Microsoft.Network.VirtualNetworkCombo",
            "label": {
              "virtualNetwork": "Virtual network",
              "subnets": "Subnets"
            },
            "toolTip": {
              "virtualNetwork": "Virtual Network Name",
              "subnets": "Create a separate subnet for Barracuda NGFW"
            },
            "defaultValue": {
              "name": "newVirtualNetwork",
              "addressPrefixSize": "/16"
            },
            "constraints": {
              "minAddressPrefixSize": "/24"
            },
            "subnets": {
              "fwSubnet": {
                "label": "Firewall Subnet",
                "defaultValue": {
                  "name": "FirewallSubnet",
                  "addressPrefixSize": "/29"
                },
                "constraints": {
                  "minAddressPrefixSize": "/30",
                  "minAddressCount": 2,
                  "requireContiguousAddresses": false
                }
              }

            }
          }
        ]
      },
      {
        "name": "StorageConfig",
        "label": "Storage Settings",
        "subLabel": {
          "preValidation": "Configure storage settings for firewall disks",
          "postValidation": "Done"
        },
        "bladeTitle": "Storage Settings",
        "elements": [
          {
            "name": "fwVmSizeBasic",
            "type": "Microsoft.Common.DropDown",
            "label": "Firewall Instance Size",
            "toolTip": "Choose instance size for newly created Barracuda NextGen Firewall corresponding to your license",
            "defaultValue": "Standard_A1",
            "constraints": {
              "required": true,
              "allowedValues": [
                {
                  "label": "Small (Level 2)",
                  "value": "Standard_A1"
                },
                {
                  "label": "Medium (Level 4)",
                  "value": "Standard_D2_v2"
                },
                {
                  "label": "Large (Level 6)",
                  "value": "Standard_D3_v2"
                },
                {
                  "label": "X-Large (Level 8)",
                  "value": "Standard_DS4_v2"
                }
              ]
            },
            "visible": true
          },
          {
            "name": "storageAccount",
            "type": "Microsoft.Storage.StorageAccountSelector",
            "label": "Storage Account",
            "toolTip": "Storage Account for the disk drive of the Barracuda NextGen Firewall",
            "defaultValue": {
              "type": "Standard_LRS"
            },
            "constraints": {
              "allowedTypes": [
                "Standard_LRS",
                "Premium_LRS"
              ],
              "required": true
            }
          }
        ]
      },
      {
        "name": "AdvancedConfig",
        "label": "Advanced",
        "subLabel": {
          "preValidation": "Advanced Settings",
          "postValidation": "Done"
        },
        "bladeTitle": "Advanced",
        "elements": [
          {
            "name": "fwVmAddress",
            "type": "Microsoft.Common.TextBox",
            "label": "Barracuda NextGen Firewall Private IP Address",
            "toolTip": "Provide IP address from Firewall Subnet defined above",
            "defaultValue": "[steps( 'NetworkConfig' ).virtualNetwork.subnets.fwSubnet.startAddress]",
            "constraints": {
              "required": false,
              "regex": "^([01]?\\d\\d?|2[0-4]\\d|25[0-5])\\.([01]?\\d\\d?|2[0-4]\\d|25[0-5])\\.([01]?\\d\\d?|2[0-4]\\d|25[0-5])\\.([01]?\\d\\d?|2[0-4]\\d|25[0-5])$",
              "validationMessage": "Must be a valid IPv4 address from Firewall Subnet"

            }
          },
          {
            "name": "fwVmSize",
            "type": "Microsoft.Compute.SizeSelector",
            "label": "Virtual firewall instance size",
            "toolTip": "The size of virtual machine to provision.",
            "recommendedSizes": [
              "[steps( 'StorageConfig' ).fwVmSizeBasic]",
              "Standard_A1",
              "Standard_D2_v2",
              "Standard_D3_v2",
              "Standard_D4_v2"
            ],
            "constraints": {
              "allowedSizes": [
                "Standard_A1",
                "Standard_A2",
                "Standard_A3",
                "Standard_A4",
                "Standard_D2",
                "Standard_D3",
                "Standard_D4",
                "Standard_D2_v2",
                "Standard_D3_v2",
                "Standard_D4_v2",
                "Standard_DS2_v2",
                "Standard_DS3_v2",
                "Standard_DS4_v2"
              ],
              "required": true
            },
            "osPlatform": "Linux",
            "imageReference": {
              "publisher": "barracudanetworks",
              "offer": "barracuda-ng-firewall",
              "sku": "byol"
            },
            "count": "1"
          }

        ]
      }
    ],
    "outputs": {
      "fwVmName": "[basics( 'fwVmName' )]",
      "fwVmSizeBasic": "[steps( 'StorageConfig' ).fwVmSizeBasic]",
      "fwVmSize": "[steps( 'AdvancedConfig' ).fwVmSize]",
      "fwVmAddress": "[steps( 'AdvancedConfig' ).fwVmAddress]",
      "fwVmRootPasswd": "[basics( 'fwVmRootPasswd' )]",
      "location": "[location()]",
      "fwSubnetName": "[steps( 'NetworkConfig' ).virtualNetwork.subnets.fwSubnet.name]",
      "fwSubnetAddress": "[steps( 'NetworkConfig' ).virtualNetwork.subnets.fwSubnet.addressPrefix]",
      "publicIpName": "[steps( 'NetworkConfig' ).publicIp.name]",
      "publicIpDnsName": "[steps( 'NetworkConfig' ).publicIp.domaneNameLabel]",
      "newStorageAccountName": "[steps( 'StorageConfig' ).storageAccount.name]",
      "vnetName": "[steps( 'NetworkConfig' ).virtualNetwork.name]",
      "vnetAddressSpace": "[steps( 'NetworkConfig').virtualNetwork.addressPrefix]"
    }
  }




}